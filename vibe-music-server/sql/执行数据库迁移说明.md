# 数据库迁移执行说明

## 迁移内容
为用户表 `tb_user` 添加以下字段：
- `gender` (int): 用户类型：0-男，1-女，2-组合/乐队，3-原创歌手
- `birth` (date): 用户生日
- `area` (varchar(30)): 用户国籍

## 执行方式

### 方式一：使用 PowerShell 脚本（推荐）

1. **打开 PowerShell**
   - 按 `Win + X`，选择 "Windows PowerShell" 或 "终端"
   - 或者按 `Win + R`，输入 `powershell`，按回车

2. **导航到 SQL 目录**
   ```powershell
   cd D:\15591\Desktop\MusicPlayer\vibe-music-server\sql
   ```

3. **执行迁移脚本**
   ```powershell
   .\execute-user-artist-migration.ps1
   ```

4. **如果需要自定义参数**（数据库名、用户名、密码等）
   ```powershell
   .\execute-user-artist-migration.ps1 -Username "root" -Password "你的密码" -Database "vibe_music"
   ```

5. **如果 MySQL 不在 PATH 中**
   ```powershell
   .\execute-user-artist-migration.ps1 -MysqlPath "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe"
   ```

### 方式二：使用 MySQL 命令行

1. **打开命令提示符或 PowerShell**

2. **执行 MySQL 命令**
   ```bash
   mysql -u root -p3127 vibe_music < add_user_artist_fields.sql
   ```
   
   或者交互式输入密码：
   ```bash
   mysql -u root -p vibe_music < add_user_artist_fields.sql
   ```

3. **如果 MySQL 不在 PATH 中，使用完整路径**
   ```bash
   "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe" -u root -p3127 vibe_music < add_user_artist_fields.sql
   ```

### 方式三：使用 MySQL Workbench 或其他数据库工具

1. **打开 MySQL Workbench** 或其他数据库管理工具（如 Navicat、DBeaver 等）

2. **连接到数据库**
   - 主机：localhost
   - 端口：3306
   - 用户名：root
   - 密码：3127（根据你的实际配置）
   - 数据库：vibe_music

3. **打开 SQL 文件**
   - 在 MySQL Workbench 中：File → Open SQL Script
   - 选择文件：`add_user_artist_fields.sql`

4. **执行 SQL**
   - 点击执行按钮（⚡ 图标）或按 `Ctrl + Shift + Enter`

### 方式四：直接在 MySQL 命令行中执行

1. **登录 MySQL**
   ```bash
   mysql -u root -p3127
   ```

2. **选择数据库**
   ```sql
   USE vibe_music;
   ```

3. **执行 SQL 语句**
   ```sql
   ALTER TABLE `tb_user` 
   ADD COLUMN `gender` int(0) NULL DEFAULT NULL COMMENT '用户类型：0-男，1-女，2-组合/乐队，3-原创歌手' AFTER `introduction`,
   ADD COLUMN `birth` date NULL DEFAULT NULL COMMENT '用户生日' AFTER `gender`,
   ADD COLUMN `area` varchar(30) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '用户国籍' AFTER `birth`;
   ```

## 验证迁移是否成功

执行以下 SQL 查询来验证字段是否添加成功：

```sql
-- 查看表结构
DESCRIBE tb_user;

-- 或者查看特定字段
SHOW COLUMNS FROM tb_user LIKE 'gender';
SHOW COLUMNS FROM tb_user LIKE 'birth';
SHOW COLUMNS FROM tb_user LIKE 'area';

-- 或者查看所有字段
SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT, COLUMN_COMMENT 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = 'vibe_music' 
  AND TABLE_NAME = 'tb_user' 
  AND COLUMN_NAME IN ('gender', 'birth', 'area');
```

## 常见问题

### 1. 如果字段已存在
如果执行时提示字段已存在，可以：
- 忽略错误（如果字段已正确添加）
- 或者先删除字段再重新添加：
  ```sql
  ALTER TABLE `tb_user` DROP COLUMN `gender`;
  ALTER TABLE `tb_user` DROP COLUMN `birth`;
  ALTER TABLE `tb_user` DROP COLUMN `area`;
  ```
  然后重新执行迁移脚本

### 2. 权限问题
如果遇到权限错误，确保：
- MySQL 用户有 ALTER TABLE 权限
- 使用 root 用户或具有足够权限的用户

### 3. 字符集问题
如果遇到字符集错误，确保数据库和表的字符集是 `utf8mb4`

## 注意事项

⚠️ **执行前请备份数据库！**

```bash
# 备份命令示例
mysqldump -u root -p3127 vibe_music > vibe_music_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').sql
```

执行迁移后，重启 Spring Boot 应用以使更改生效。

