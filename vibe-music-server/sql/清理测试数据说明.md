# 清理测试数据说明文档

## 概述

本文档说明如何清理数据库中的测试数据，包括测试用户（testuser%、test_user_%）及其所有相关数据。

## ⚠️ 重要提示

1. **执行前请务必备份数据库！**
2. 删除操作不可逆，请谨慎执行
3. 建议先在测试环境验证脚本的正确性
4. 执行前请确认数据库连接信息正确

## 删除范围

以下数据将被删除：

- ✅ 所有用户名以 `testuser` 或 `test_user_` 开头的用户
- ✅ 这些用户上传的原创歌曲
- ✅ 这些用户的收藏记录
- ✅ 这些用户的评论
- ✅ 这些用户的论坛帖子
- ✅ 这些用户的论坛回复
- ✅ 这些用户的反馈记录

## 方法一：使用PowerShell脚本（推荐）

### 步骤1：预览将要删除的数据

```powershell
cd vibe-music-server\scripts
.\clean_test_data.ps1 -Preview
```

这将显示将要删除的测试数据统计，但**不会执行删除操作**。

### 步骤2：修改数据库连接信息（如需要）

编辑 `clean_test_data.ps1`，修改以下参数：

```powershell
$dbHost = "localhost"      # 数据库主机
$dbPort = "3306"           # 数据库端口
$dbName = "vibe_music"     # 数据库名
$dbUser = "root"           # 数据库用户名
$dbPassword = "3127"       # 数据库密码
```

### 步骤3：执行删除操作

```powershell
.\clean_test_data.ps1
```

脚本会：
1. 显示警告信息
2. 要求确认（输入 `yes` 继续）
3. 执行删除操作
4. 显示删除结果和验证信息

## 方法二：直接执行SQL脚本

### 步骤1：连接到数据库

```bash
mysql -u root -p3127 vibe_music
```

或者使用MySQL客户端工具（如Navicat、MySQL Workbench等）。

### 步骤2：查看将要删除的数据（可选）

执行以下查询查看统计信息：

```sql
-- 查看测试用户数量
SELECT COUNT(*) AS test_user_count
FROM tb_user 
WHERE username LIKE 'testuser%' OR username LIKE 'test_user_%';

-- 查看测试用户上传的歌曲数量
SELECT COUNT(*) AS test_song_count
FROM tb_song s 
INNER JOIN tb_user u ON s.creator_id = u.id 
WHERE u.username LIKE 'testuser%' OR u.username LIKE 'test_user_%';
```

### 步骤3：执行删除脚本

**方式A：使用简化版脚本（推荐）**

```bash
mysql -u root -p3127 vibe_music < sql/clean_test_data_simple.sql
```

或者在MySQL客户端中执行：

```sql
source sql/clean_test_data_simple.sql
```

**方式B：使用完整版脚本（包含详细统计和验证）**

```bash
mysql -u root -p3127 vibe_music < sql/clean_test_data.sql
```

### 步骤4：验证删除结果

执行以下查询确认删除成功：

```sql
-- 检查是否还有测试用户
SELECT COUNT(*) AS remaining_test_users
FROM tb_user 
WHERE username LIKE 'testuser%' OR username LIKE 'test_user_%';

-- 应该返回 0
```

## 方法三：手动执行SQL（高级用户）

如果只想删除特定类型的数据，可以单独执行相关SQL语句：

```sql
-- 1. 创建临时表存储测试用户ID
CREATE TEMPORARY TABLE temp_test_user_ids AS
SELECT id FROM tb_user WHERE username LIKE 'testuser%' OR username LIKE 'test_user_%';

-- 2. 删除测试用户上传的歌曲
DELETE s FROM tb_song s
INNER JOIN temp_test_user_ids t ON s.creator_id = t.id;

-- 3. 删除测试用户的收藏
DELETE uf FROM tb_user_favorite uf
INNER JOIN temp_test_user_ids t ON uf.user_id = t.id;

-- 4. 删除测试用户的评论
DELETE c FROM tb_comment c
INNER JOIN temp_test_user_ids t ON c.user_id = t.id;

-- 5. 删除测试用户的论坛数据
DELETE fr FROM tb_forum_reply fr
INNER JOIN temp_test_user_ids t ON fr.user_id = t.id;
DELETE fp FROM tb_forum_post fp
INNER JOIN temp_test_user_ids t ON fp.user_id = t.id;

-- 6. 删除测试用户
DELETE u FROM tb_user u
WHERE u.username LIKE 'testuser%' OR u.username LIKE 'test_user_%';

-- 7. 清理临时表
DROP TEMPORARY TABLE temp_test_user_ids;
```

## 常见问题

### Q1: 执行脚本时提示外键约束错误

**A:** 脚本已经处理了外键约束问题。如果仍然遇到错误，请确保：
- MySQL版本 >= 5.7
- 执行前已禁用外键检查（脚本中已包含）

### Q2: 如何只删除特定的测试用户？

**A:** 修改WHERE条件，例如：

```sql
-- 只删除 testuser1 到 testuser10
DELETE FROM tb_user 
WHERE username REGEXP '^testuser([1-9]|10)$';
```

### Q3: 删除后如何恢复数据？

**A:** 从备份恢复。如果没有备份，数据无法恢复。**强烈建议执行前备份数据库！**

### Q4: 脚本执行后还有残留数据？

**A:** 可能是以下原因：
1. 有其他表的关联数据未清理（检查是否有其他外键关联）
2. 用户名模式不完全匹配（检查是否有其他测试用户命名模式）
3. 事务未提交（确保使用了COMMIT或SET AUTOCOMMIT=1）

## 备份数据库（重要！）

在执行删除操作前，请务必备份数据库：

```bash
# 备份整个数据库
mysqldump -u root -p3127 vibe_music > vibe_music_backup_$(date +%Y%m%d_%H%M%S).sql

# 或只备份用户表和相关表
mysqldump -u root -p3127 vibe_music tb_user tb_song tb_user_favorite tb_comment tb_forum_post tb_forum_reply > test_data_backup.sql
```

## 联系支持

如果遇到问题或需要帮助，请：
1. 检查MySQL错误日志
2. 确认数据库版本和配置
3. 查看脚本执行输出信息

---

**最后更新：** 2025年1月
**维护者：** 项目开发团队

