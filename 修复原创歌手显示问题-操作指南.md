# 修复原创歌手显示问题 - 操作指南

## 问题描述
- 管理端可以显示原创歌手 user172
- 客户端点击"歌手分类-原创歌手"时报错：`Cannot read properties of null (reading 'map')`
- API 返回 0 条记录

## 根本原因
1. 后端服务未重启，仍在使用旧代码
2. 前端未处理 API 返回 `items: null` 的情况

## 已完成的修复

### 1. 后端修复
**文件：** `vibe-music-server/src/main/java/cn/edu/seig/vibemusic/service/impl/ArtistServiceImpl.java`

- ✅ 修复 `getAllArtists` 方法：当 `gender` 为 `null` 时排除原创歌手
- ✅ 修复 `getAllArtistsAndDetail` 方法：当 `gender` 为 `null` 时排除原创歌手
- ✅ 修复返回值：当没有数据时返回空数组 `List.of()` 而不是 `null`

### 2. 前端修复
**文件：** `vibe-music-client/src/pages/artist/index.vue`

- ✅ 添加空值保护：`(res.data.items || []).map(...)`

## 🔴 必须执行的操作

### 步骤 1：重启后端服务

**方法 A：使用 IDE**
1. 在 IDE 中停止当前运行的 Spring Boot 应用
2. 重新运行 `VibeMusicApplication` 主类

**方法 B：使用命令行**
1. 停止当前后端服务（按 `Ctrl+C`）
2. 执行以下命令：
   ```bash
   cd vibe-music-server
   mvn clean package -DskipTests
   mvn spring-boot:run
   ```

### 步骤 2：刷新前端页面

1. 在浏览器中按 `Ctrl+Shift+R` 强制刷新
2. 或者清除浏览器缓存后刷新

### 步骤 3：验证修复

**客户端测试：**
1. 访问：歌手 → 歌手分类 → 原创歌手
2. 应该能看到 `user172`（如果没有数据，应该显示空列表而不是报错）

**管理端测试：**
1. 访问：歌手管理 → 类型选择"原创歌手"
2. 应该能看到 `user172`

## 验证 API

运行测试脚本验证 API 是否正常：

```powershell
.\test-artist-api.ps1
```

**期望结果：**
- 如果有原创歌手：应该返回歌手列表
- 如果没有原创歌手：应该返回空数组（不是 null）

## 数据库验证

验证数据库中是否有原创歌手：

```sql
-- 查看所有原创歌手
SELECT * FROM tb_artist WHERE gender = 3;

-- 查看符合条件的原创歌手（有已通过审核的原创歌曲）
SELECT a.* 
FROM tb_artist a 
WHERE a.gender = 3 
  AND a.name IN (
    SELECT u.username 
    FROM tb_user u 
    INNER JOIN tb_song s ON u.id = s.creator_id 
    WHERE s.is_original = true 
      AND (s.audit_status = 1 OR s.audit_status IS NULL) 
    GROUP BY u.username
  );
```

## 如果仍然有问题

### 检查清单

1. ✅ 后端服务是否已重启？
2. ✅ 前端页面是否已刷新？
3. ✅ 数据库中是否有符合条件的原创歌手？
4. ✅ Redis 缓存是否已清除？

### 清除 Redis 缓存

```bash
redis-cli KEYS "artistCache::*"
redis-cli FLUSHDB
```

或者运行：
```powershell
.\vibe-music-server\clear-artist-cache.ps1
```

## 技术细节

### 查询逻辑
- 当 `gender = 3`（原创歌手）时，使用 IN 子查询，只返回有已通过审核原创歌曲的用户
- 当 `gender = null`（全部）时，排除原创歌手（`gender != 3`），因为原创歌手需要特殊处理
- 当 `gender = 0/1/2` 时，正常查询

### 为什么需要重启
- Spring Boot 应用在运行时加载类到内存
- 修改代码后，必须重启才能加载新代码
- 缓存（`@Cacheable`）也需要重启后清除

## 总结

**核心问题：** 后端服务未重启，仍在使用旧代码

**解决方案：** 重启后端服务 + 刷新前端页面

**预期结果：** 客户端和管理端都能正确显示原创歌手

